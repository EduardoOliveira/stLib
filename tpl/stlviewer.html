{{define "stlViewer"}}
	<!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

    <button onclick="removeObject()">bla</button>
    <script type="module">
        //TODO: https://discourse.threejs.org/t/camera-zoom-to-fit-object/936/36?page=2
        import * as THREE from 'THREE';

        import { OrbitControls } from 'https://unpkg.com/three/examples/jsm/controls/OrbitControls.js';
        import { STLLoader } from 'STLLoader';

        let container;

        let camera, cameraTarget, scene, renderer, controls, uuid, loader, material;
        
        init();
        animate();

        window.addObject = function(path) {
            if(uuid!=null) {
                removeObject();
            }
            loader.load( path, function ( geometry ) {
                
                console.log("loaded")
                const mesh = new THREE.Mesh( geometry, material );

                mesh.position.set( 0, -5, 0);
                mesh.rotation.set( -1, 0, 0 );
                mesh.scale.set( 0.1, 0.1, 0.1);

                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.name = "model";
                uuid = mesh.uuid;

                scene.add( mesh );

            } );
        }
        window.removeObject = function() {
            const object = scene.getObjectByProperty( 'uuid', uuid );
            scene.remove(object);
            object.geometry.dispose();
            object.material.dispose();
            renderer.renderLists.dispose();
        }
        

        function init() {
            container = document.getElementById('3d-viewer');

            camera = new THREE.PerspectiveCamera( 35, 16 / 9, 1, 1000 );
            camera.position.set( 15, 5, 15 );

            cameraTarget = new THREE.Vector3( 0, 5, 0 );

            scene = new THREE.Scene();
            //scene.background = new THREE.Color( 0x72645b );

            // ASCII file

            loader = new STLLoader();

            material = new THREE.MeshPhongMaterial( { color: 0xAAAAAA, specular: 0x111111, shininess: 200 } );

            

            controls = new OrbitControls(camera, container);
            controls.target.set(0, 0, 0);
            controls.enablePan = true;
            controls.enableDamping = true;

            // Lights

            scene.add( new THREE.HemisphereLight( 0x443333, 0x111122 ) );

            addShadowedLight( 1, 1, 1, 0xffffff, 1.35 );
            addShadowedLight( 0.5, 1, - 1, 0xffaa00, 1 );
            // renderer

            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setPixelRatio( window.devicePixelRatio );
            let h = container.offsetWidth *(9/16);
            
            renderer.setSize( container.offsetWidth, h );
            renderer.outputEncoding = THREE.sRGBEncoding;

            renderer.shadowMap.enabled = true;

            container.appendChild( renderer.domElement );

            //

            window.addEventListener( 'resize', onWindowResize );

        }

        function addShadowedLight( x, y, z, color, intensity ) {

            const directionalLight = new THREE.DirectionalLight( color, intensity );
            directionalLight.position.set( x, y, z );
            scene.add( directionalLight );

            directionalLight.castShadow = true;

            const d = 1;
            directionalLight.shadow.camera.left = - d;
            directionalLight.shadow.camera.right = d;
            directionalLight.shadow.camera.top = d;
            directionalLight.shadow.camera.bottom = - d;

            directionalLight.shadow.camera.near = 1;
            directionalLight.shadow.camera.far = 4;

            directionalLight.shadow.bias = - 0.002;

        }

        function onWindowResize() {

            camera.aspect = (16/9);
            camera.updateProjectionMatrix();
            console.log(container.offsetWidth, container.offsetWidth *(9/16));
            renderer.setSize( container.offsetWidth, container.offsetWidth *(9/16) );

        }

        function animate() {

            requestAnimationFrame( animate );
            controls.update();
            render();

        }

        function render() {
            renderer.render( scene, camera );

        }

</script>

{{end}}

